# Book Parser

A comprehensive PDF book parsing library that extracts text, images, and chapter structure from PDF files.

## Features

- **Text Extraction**: Page-aware text extraction with automatic content detection
- **Image Extraction**: Embedded image extraction with page correlation
- **Chapter Detection**: Automatic chapter detection and structure mapping
- **Multi-format Support**: Text, image, and header chunk types
- **Relative Paths**: Images saved with relative paths for portability

## Directory Structure

```
book-parser/
├── src/
│   ├── parse-pdf-book-with-images.js    # Main parser with image support
│   └── parse-pdf-book-generic.js        # Generic parsing utilities
├── test/
│   └── parser.test.js                   # Test suite
└── README.md
```

## Usage

### Basic Parsing

```javascript
const { parsePdfWithImages } = require('./src/parse-pdf-book-with-images');

async function parseBook() {
    const { book, chapters, imagesFolderPath } = await parsePdfWithImages(
        '/path/to/book-folder'
    );
    
    console.log(`Parsed: ${book.title} by ${book.author}`);
    console.log(`Chapters: ${chapters.length}`);
    console.log(`Images folder: ${imagesFolderPath}`);
}
```

### Command Line Usage

```bash
node src/parse-pdf-book-with-images.js BOOK_FOLDER_PATH
```

**Arguments:**
- `BOOK_FOLDER_PATH`: Path to the book folder containing a PDF file and config.json

**Requirements:**
- The folder must contain a PDF file (first .pdf file found will be used)
- The folder must contain a `config.json` file (book configuration)

**Outputs:**
- Creates `output.json` in the same folder
- Creates `images/` subfolder with extracted images

**Example:**
```bash
node src/parse-pdf-book-with-images.js ./books/my-book/
```

**Book folder structure:**
```
my-book/
├── book.pdf          # Any PDF file name
├── config.json       # Book configuration
├── output.json       # Generated by parser
└── images/           # Generated by parser
    └── Book-Title/
        ├── page-001-image-1.jpg
        └── ...
```

## Configuration File Format

The book folder must contain a `config.json` file with the following structure:

```json
{
    "metadata": {
        "title": "Book Title",
        "author": "Author Name"
    },
    "chapters": {
        "patterns": [
            "CHAPTER \\d+",
            "Chapter \\d+:"
        ],
        "exclusions": [
            "REFERENCES",
            "INDEX"
        ]
    }
}
```

## Output Format

The parser outputs a JSON file with the following structure:

```json
{
    "book": {
        "title": "Book Title",
        "author": "Author Name",
        "totalChapters": 10,
        "totalWords": 50000,
        "coverImage": "page-001-image-1.jpg",
        "createdAt": "2024-01-01T00:00:00.000Z",
        "updatedAt": "2024-01-01T00:00:00.000Z"
    },
    "chapters": [
        {
            "chapterNumber": 1,
            "title": "Chapter Title",
            "content": {
                "chunks": [
                    {
                        "index": 0,
                        "text": "Chapter content...",
                        "type": "text",
                        "wordCount": 150,
                        "pageNumber": 1
                    },
                                         {
                         "index": 1,
                         "text": "",
                         "type": "image",
                         "wordCount": 0,
                         "pageNumber": 2,
                         "imageName": "page-002-image-1.jpg",
                         "imageAlt": "Figure 1 (Page 2)"
                     }
                ]
            },
            "wordCount": 3500
        }
    ],
    "metadata": {
        "parsedAt": "2024-01-01T00:00:00.000Z",
        "totalChapters": 10,
        "totalWords": 50000,
        "avgWordsPerChapter": 5000,
        "hasImages": true,
        "totalImages": 15,
        "imagesFolderPath": "./images/Book-Title"
    }
}
```

## Chunk Types

- **text**: Regular text content
- **image**: Embedded images with page correlation
- **header**: Chapter titles and headings

## Images

Images are extracted to `./images/{book-title}/` relative to the book folder. The folder path is stored in `metadata.imagesFolderPath`, and individual images use only the filename in `imageName`.

**File Structure:**
```
book-folder/
├── config.json
├── book.pdf
├── output.json
└── images/
    └── Book-Title/
        ├── page-001-image-1.jpg
        ├── page-002-image-1.jpg
        └── ...
```

**Data Structure:**
- **Folder Path**: Stored in `metadata.imagesFolderPath` (e.g., `"./images/Book-Title"`)
- **Individual Images**: Use `imageName` property (e.g., `"page-002-image-1.jpg"`)
- **Full Path**: Combine `imagesFolderPath + "/" + imageName`

**Naming Convention:**
- `page-{pageNumber}-image-{imageIndex}.jpg`

## Testing

Run the test suite:

```bash
node test/parser.test.js
```

The test suite validates:
- Book structure integrity
- Chapter detection accuracy
- Image extraction
- Relative path generation
- Expected content matching

## Dependencies

- `fs` - File system operations
- `path` - Path utilities
- `pdf2pic` - PDF to image conversion
- `sharp` - Image processing
- `pdf-parse` - PDF text extraction
- `pdfjs-dist` - PDF.js for advanced PDF operations

## Error Handling

The parser includes comprehensive error handling for:
- Missing PDF files
- Invalid configuration files
- PDF parsing errors
- Image extraction failures
- File system operations

## Performance

- Processes large PDFs efficiently
- Memory-conscious chunk processing
- Parallel image extraction where possible
- Progress logging for long operations 