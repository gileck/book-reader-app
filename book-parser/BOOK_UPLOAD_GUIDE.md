# Complete Guide: Uploading a New Book to the Database

This guide covers the complete process of parsing a PDF book and uploading it to the database with images.

## Prerequisites

### Required Software
- Node.js (v14 or higher)
- `pdfimages` command-line tool (from poppler-utils)
  ```bash
  # Install on macOS
  brew install poppler
  
  # Install on Ubuntu/Debian
  sudo apt-get install poppler-utils
  ```

### Environment Variables
Create a `.env` file in the `book-parser/` directory:
```bash
# Vercel Blob Storage
BLOB_READ_WRITE_TOKEN=your_vercel_blob_token

# Optional: Enable debug mode
DEBUG_TEXT=/path/to/debug/output.txt
```

### MongoDB Connection
The scripts use a hardcoded MongoDB connection string. Ensure you have access to the database.

## Step-by-Step Process

### Step 1: Prepare Your Book Folder

Create a folder structure like this:
```
MyBook/
├── book.pdf          # Your PDF file (any name)
├── config.json       # Optional: book configuration
```

**Optional Config File** (`config.json`):
```json
{
    "metadata": {
        "title": "The Great Book",
        "author": "Author Name"
    },
    "chapterNames": [
        "Introduction: The Beginning",
        "Chapter 1: First Steps",
        "Chapter 2: Advanced Topics",
        "Conclusion: Final Thoughts"
    ],
    "chapterPatterns": [
        "^chapter\\s+(\\d+|one|two|three|four|five|six|seven|eight|nine|ten)\\b",
        "^(\\d+)\\.\\s+([A-Za-z][a-zA-Z\\s]{8,40})$"
    ],
    "excludePatterns": [
        "^(appendix|bibliography|index|notes|references)$"
    ]
}
```

### Step 2: Parse the PDF Book

Navigate to the book parser directory and run:

```bash
cd book-parser/parser/

# Basic parsing (recommended - uses TOC extraction)
node parse-pdf-book-generic.js /path/to/MyBook/

# With custom config file
node parse-pdf-book-generic.js /path/to/MyBook/ /path/to/MyBook/config.json

# With debug mode for troubleshooting
node parse-pdf-book-generic.js /path/to/MyBook/ --debug
```

**Expected Output:**
```
🚀 Starting PDF book parsing...
📁 PDF: /path/to/MyBook/book.pdf
⚙️  Config: None (using TOC extraction)
📄 Output: /path/to/MyBook/output.json
🔍 Attempting TOC extraction...
✅ Found 10 chapters via pdf_bookmarks
🖼️  Extracting embedded images from PDF...
📁 Created images directory: /path/to/MyBook/images/The-Great-Book
✅ Processed 15 images with correct page numbers
✅ Book parsed and saved to file successfully!
📖 Title: "The Great Book"
👤 Author: Author Name
📚 Chapters: 10
📝 Total words: 45,000
🖼️ Total images: 15
📄 Output file: /path/to/MyBook/output.json
```

### Step 3: Verify Parsing Results

Check the generated files:

```bash
ls -la /path/to/MyBook/
```

**Expected Structure:**
```
MyBook/
├── book.pdf
├── config.json
├── output.json        # ✅ Generated by parser
├── images/            # ✅ Generated by parser
│   └── The-Great-Book/
│       ├── page-001-image-1.jpg
│       ├── page-005-image-1.jpg
│       └── ...
└── debug/             # 🐛 Only if --debug was used
    ├── 1-pdfData-text.txt
    ├── 2-raw-bookMetadata.json
    └── ...
```

**Verify `output.json` Structure:**
```bash
# Check if output.json has the expected structure
node -e "
const data = JSON.parse(require('fs').readFileSync('/path/to/MyBook/output.json', 'utf8'));
console.log('✅ Book:', data.book.title, 'by', data.book.author);
console.log('✅ Chapters:', data.chapters.length);
console.log('✅ Total words:', data.book.totalWords);
console.log('✅ Has images:', data.metadata.hasImages);
console.log('✅ Total images:', data.metadata.totalImages);
"
```

**Verify Images:**
```bash
# Count extracted images
find /path/to/MyBook/images/ -name "*.jpg" -o -name "*.png" | wc -l

# List first few images
ls /path/to/MyBook/images/*/page-*.jpg | head -5
```

### Step 4: Upload Book Content to Database

```bash
cd book-parser/upload-book/

# Upload the book content
node upload-parsed-book.js /path/to/MyBook/

# Or force overwrite if book already exists
node upload-parsed-book.js /path/to/MyBook/ --force
```

**Expected Output:**
```
🚀 Starting book upload...
📄 Found output file: output.json
🖼️  Found images folder with 15 image files
🔌 Connecting to MongoDB...
✅ Connected successfully!
📖 Inserting book: "The Great Book"...
   Book inserted with ID: 507f1f77bcf86cd799439011
📚 Inserting 10 chapters...
   Inserted chapters 1-10 (10/10)
✅ Book uploaded successfully!
📖 Title: "The Great Book"
👤 Author: Author Name
🆔 Book ID: 507f1f77bcf86cd799439011
📚 Chapters: 10
📝 Total words: 45,000
```

### Step 5: Upload Images to Vercel Blob

```bash
# Upload images using the exact book title from the database
node upload-images-to-vercel-blob.js /path/to/MyBook/ "The Great Book"
```

**Expected Output:**
```
🚀 Starting image upload to Vercel Blob...
📸 Found 15 image files
🔌 Connecting to MongoDB...
✅ Connected to MongoDB!
📖 Found book: "The Great Book" (ID: 507f1f77bcf86cd799439011)
☁️  Uploading images to Vercel Blob: books/The-Great-Book/images/
   📤 Uploading: page-001-image-1.jpg
   📤 Uploading: page-005-image-1.jpg
   ...
✅ Successfully uploaded 15 images to Vercel Blob
📚 Updated book with relative imageBaseURL: /The-Great-Book/images/
   📝 Updated Chapter 1 with image references
   📝 Updated Chapter 3 with image references
   ...
✅ Image upload and database update completed successfully!
📊 Summary:
   📖 Book: "The Great Book"
   📸 Images uploaded: 15
   📁 Relative path: /The-Great-Book/images/
   ☁️  Full Blob URL: https://xyz.public.blob.vercel-storage.com/books/The-Great-Book/images/
```

## Verification Steps

### 1. Verify Database Content

Connect to your MongoDB database and check:

```javascript
// Check book was inserted
db.books.findOne({title: "The Great Book"})

// Check chapters were inserted
db.chapters.find({bookId: ObjectId("507f1f77bcf86cd799439011")}).count()

// Check image references in chapters
db.chapters.findOne(
  {bookId: ObjectId("507f1f77bcf86cd799439011"), "content.chunks.type": "image"},
  {"content.chunks.$": 1}
)
```

### 2. Verify Images in Blob Storage

Check that images are accessible:
```bash
# Test a few image URLs (replace with actual URLs from upload output)
curl -I "https://xyz.public.blob.vercel-storage.com/books/The-Great-Book/images/page-001-image-1.jpg"
```

### 3. Test in Application

1. Start your Book Reader App
2. Navigate to the book library
3. Find "The Great Book" in the list
4. Open the book and verify:
   - Text content displays correctly
   - Images appear inline with text
   - Chapter navigation works
   - No broken image links

## Troubleshooting

### Common Issues

**1. No chapters detected:**
```bash
# Run with debug mode to see raw text
node parse-pdf-book-generic.js /path/to/MyBook/ --debug

# Check the debug files
cat /path/to/MyBook/debug/1-pdfData-text.txt | head -100
```

**2. Images not extracted:**
```bash
# Check if pdfimages is installed
which pdfimages

# Check PDF for embedded images manually
pdfimages -list /path/to/MyBook/book.pdf
```

**3. Upload fails with "Book already exists":**
```bash
# Use force flag to overwrite
node upload-parsed-book.js /path/to/MyBook/ --force
```

**4. Image upload fails:**
```bash
# Check environment variables
echo $BLOB_READ_WRITE_TOKEN

# Verify book title matches exactly
node -e "
const { MongoClient } = require('mongodb');
const client = new MongoClient('your_mongodb_uri');
client.connect().then(async () => {
  const books = await client.db('book_reader_db').collection('books').find({}).toArray();
  console.log('Available books:');
  books.forEach(book => console.log(' -', book.title));
  client.close();
});
"
```

### Debug Mode Files

When using `--debug`, check these files for troubleshooting:
- `debug/1-pdfData-text.txt` - Raw extracted text
- `debug/2-raw-bookMetadata.json` - Detected metadata
- `debug/3-raw-chapters.json` - Detected chapters
- `debug/4-raw-pdfjsDocument.json` - PDF document info
- `debug/5-raw-outline.json` - PDF bookmarks/outline
- `debug/tocData.json` - Table of contents extraction

## Script Quick Reference

### Key Files and Scripts

| Script | Purpose | Location |
|--------|---------|----------|
| `parse-pdf-book-generic.js` | Parse PDF and extract images | `book-parser/parser/` |
| `upload-parsed-book.js` | Upload book content to MongoDB | `book-parser/upload-book/` |
| `upload-images-to-vercel-blob.js` | Upload images to Vercel Blob | `book-parser/upload-book/` |

### Command Summary

```bash
# 1. Parse PDF
cd book-parser/parser/
node parse-pdf-book-generic.js /path/to/MyBook/

# 2. Upload content
cd ../upload-book/
node upload-parsed-book.js /path/to/MyBook/

# 3. Upload images
node upload-images-to-vercel-blob.js /path/to/MyBook/ "Exact Book Title"
```

## Success Checklist

✅ PDF parsed successfully with correct chapter count  
✅ Images extracted to `images/` folder  
✅ `output.json` contains book and chapters data  
✅ Book uploaded to MongoDB database  
✅ Chapters uploaded with correct text chunks  
✅ Images uploaded to Vercel Blob storage  
✅ Book record updated with `imageBaseURL`  
✅ Chapter chunks updated with `imageName` references  
✅ Images display correctly in the Book Reader App  

The book is now ready for reading in your Book Reader App! 