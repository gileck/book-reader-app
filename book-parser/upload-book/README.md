# Upload Book Scripts

This directory contains scripts for uploading parsed books and their images to the Book Reader App.

## Scripts

### 1. upload-parsed-book.js

Uploads a parsed book (text content and metadata) to the MongoDB database.

#### Usage
```bash
node upload-parsed-book.js BOOK_FOLDER_PATH [--force]
```

#### Arguments
- `BOOK_FOLDER_PATH`: Path to the book folder containing `output.json` (required)
- `--force`: Force upload even if book already exists (optional)

#### Example
```bash
node upload-parsed-book.js ../files/MyBook/
node upload-parsed-book.js ./books/transformers/ --force
```

### 2. upload-images-to-s3.js

Uploads all images from a book folder to AWS S3 and updates the database with image references.

#### Usage
```bash
node upload-images-to-s3.js BOOK_FOLDER_PATH BOOK_TITLE
```

#### Arguments
- `BOOK_FOLDER_PATH`: Path to the book folder containing `images/` subfolder (required)
- `BOOK_TITLE`: Exact title of the book as stored in the database (required)

#### Example
```bash
node upload-images-to-s3.js ../files/MyBook/ "The Great Book"
node upload-images-to-s3.js ./books/transformers/ "Transformer"
```

#### Environment Variables Required
```bash
AWS_ACCESS_KEY_ID=your_access_key
AWS_SECRET_ACCESS_KEY=your_secret_key
AWS_REGION=us-east-1  # optional, defaults to us-east-1
```

## Workflow

For a complete book upload with images:

1. **Parse the book** using the book parser to generate `output.json` and extract images
2. **Upload book content**:
   ```bash
   node upload-parsed-book.js /path/to/book/folder/
   ```
3. **Upload images to S3**:
   ```bash
   node upload-images-to-s3.js /path/to/book/folder/ "Book Title"
   ```

## Book Folder Structure

```
MyBook/
├── output.json       # Generated by parser (required for upload-parsed-book.js)
├── images/           # Generated by parser (required for upload-images-to-s3.js)
│   ├── page-001-image-1.jpg
│   ├── page-002-image-1.png
│   └── ...
├── book.pdf          # Original PDF file
└── config.json       # Book configuration
```

## How Images Work

### Storage
- Images are uploaded to AWS S3 in the path: `Book_Reader_App/books/{book-title}/images/`
- The book record is updated with `imageBaseURL` as a relative path (e.g., `/Transformer/images/`)
- Chapter chunks use `imageName` (filename only) instead of full URLs

### Reader Display
- The Reader component constructs image URLs by combining three parts:
  - S3 base path (hardcoded): `https://app-template-1252343.s3.amazonaws.com/Book_Reader_App/books`
  - Book's relative path: `book.imageBaseURL` (e.g., `/Transformer/images/`)
  - Image filename: `chunk.imageName` (e.g., `page-005-image-1.jpg`)
- Full URL example: `https://app-template-1252343.s3.amazonaws.com/Book_Reader_App/books/Transformer/images/page-005-image-1.jpg`

### Database Changes
- **Books collection**: Added `imageBaseURL` field (stores relative path, not full URL)
- **Chapters collection**: Changed `imageUrl` to `imageName` in text chunks
- **S3 base path**: Hardcoded in application constants for easy future migration

## Error Handling

Both scripts include comprehensive error handling:
- Validates input parameters and file structure
- Checks for required environment variables
- Provides clear error messages and usage instructions
- Verifies database connections before processing

## AWS S3 Configuration

The scripts use the same S3 configuration as the main application:
- Bucket: `app-template-1252343`
- App prefix: `Book_Reader_App/`
- Images path: `Book_Reader_App/books/{book-title}/images/`
- Supported formats: `.jpg`, `.jpeg`, `.png`, `.gif`, `.webp` 