# Upload Book Scripts

This directory contains scripts for uploading parsed books and their images to the Book Reader App, with support for the latest parser improvements.

## Scripts

### 1. upload-parsed-book.js

Uploads a parsed book (text content and metadata) to the MongoDB database with enhanced validation for page-aware content.

#### Usage
```bash
node upload-parsed-book.js BOOK_FOLDER_PATH [--force]
```

#### Arguments
- `BOOK_FOLDER_PATH`: Path to the book folder containing `output.json` (required)
- `--force`: Force upload even if book already exists (optional)

#### Example
```bash
node upload-parsed-book.js ../files/MyBook/
node upload-parsed-book.js ./books/transformers/ --force
```

#### New Features (2024)
- **Page-Aware Validation**: Validates chunks with page numbers and proper correlation
- **Enhanced Chunk Support**: Handles text chunks with pageNumber fields and improved image chunks
- **Parser Summary Recognition**: Compatible with new parser-summary.json output files

### 2. upload-images-to-vercel-blob.js

Uploads all images from a book folder to Vercel Blob and updates the database with image references, with enhanced page correlation.

#### Usage
```bash
node upload-images-to-vercel-blob.js BOOK_FOLDER_PATH BOOK_TITLE
```

#### Arguments
- `BOOK_FOLDER_PATH`: Path to the book folder containing `images/` subfolder (required)
- `BOOK_TITLE`: Exact title of the book as stored in the database (required)

#### Example
```bash
node upload-images-to-vercel-blob.js ../files/MyBook/ "The Great Book"
node upload-images-to-vercel-blob.js ./books/transformers/ "Transformer: the deep chemistry of life and death"
```

#### Environment Variables Required
```bash
BLOB_READ_WRITE_TOKEN=your_vercel_blob_token
```

#### New Features (2024)
- **Page-Aware Image Handling**: Preserves pageNumber correlation during upload
- **Enhanced Image Organization**: Better handling of images with precise page positioning
- **Improved Error Handling**: Better validation and error messages

### 3. upload-images-to-s3.js

Uploads all images from a book folder to AWS S3 and updates the database with image references.

#### Usage
```bash
node upload-images-to-s3.js BOOK_FOLDER_PATH BOOK_TITLE
```

#### Arguments
- `BOOK_FOLDER_PATH`: Path to the book folder containing `images/` subfolder (required)
- `BOOK_TITLE`: Exact title of the book as stored in the database (required)

#### Example
```bash
node upload-images-to-s3.js ../files/MyBook/ "The Great Book"
node upload-images-to-s3.js ./books/transformers/ "Transformer"
```

#### Environment Variables Required
```bash
AWS_ACCESS_KEY_ID=your_access_key
AWS_SECRET_ACCESS_KEY=your_secret_key
AWS_REGION=us-east-1  # optional, defaults to us-east-1
```

## Enhanced Workflow (2024)

For a complete book upload with the latest parser improvements:

1. **Parse the book** using the enhanced parser with automatic TOC extraction:
   ```bash
   cd book-parser/parser/
   node parse-pdf-book-generic.js /path/to/book.pdf
   ```

2. **Review parser results**:
   ```bash
   # Check the automatically generated summary
   cat /path/to/book/folder/parser-summary.json
   ```

3. **Upload book content** with enhanced validation:
   ```bash
   cd book-parser/upload-book/
   node upload-parsed-book.js /path/to/book/folder/
   ```

4. **Upload images** with page correlation:
   ```bash
   # For Vercel Blob (recommended)
   node upload-images-to-vercel-blob.js /path/to/book/folder/ "Book Title"
   
   # For AWS S3 (alternative)
   node upload-images-to-s3.js /path/to/book/folder/ "Book Title"
   ```

## Enhanced Book Folder Structure

```
MyBook/
├── output.json               # Generated by parser (required for upload-parsed-book.js)
├── parser-summary.json       # NEW: Generated by parser (statistics and previews)
├── images/                   # Generated by parser (required for image upload scripts)
│   └── Book-Title/
│       ├── page-001-image-1.jpg
│       ├── page-007-image-1.jpg
│       ├── page-007-image-2.jpg
│       └── ...
├── book.pdf                  # Original PDF file
├── config.json               # Book configuration (optional)
└── debug/                    # Debug files (if --debug was used)
    ├── 1-pdfData-text.txt
    ├── 2-raw-bookMetadata.json
    ├── 3-raw-chapters.json
    ├── 4-raw-pdfjsDocument.json
    ├── 5-raw-outline.json
    └── tocData.json
```

## Enhanced Image Handling

### Storage Options

#### Vercel Blob (Recommended)
- Images are uploaded to Vercel Blob storage
- The book record is updated with `imageBaseURL` as a relative path (e.g., `/Book-Title/images/`)
- Chapter chunks use `imageName` (filename only) with preserved `pageNumber` correlation
- Automatic URL construction for optimal performance

#### AWS S3 (Alternative)
- Images are uploaded to AWS S3 in the path: `Book_Reader_App/books/{book-title}/images/`
- The book record is updated with `imageBaseURL` as a relative path (e.g., `/Book-Title/images/`)
- Chapter chunks use `imageName` (filename only) instead of full URLs

### Enhanced Reader Display
- The Reader component constructs image URLs by combining three parts:
  - **Storage base path**: Configurable based on storage provider
  - **Book's relative path**: `book.imageBaseURL` (e.g., `/Book-Title/images/`)
  - **Image filename**: `chunk.imageName` (e.g., `page-007-image-1.jpg`)
- **Page correlation**: Images display at correct positions using `chunk.pageNumber`
- **Enhanced naming**: Zero-padded page numbers for proper sorting (`page-007-image-1.jpg`)

### Enhanced Database Changes
- **Books collection**: 
  - Added `imageBaseURL` field (stores relative path, not full URL)
  - Enhanced metadata with parsing statistics
- **Chapters collection**: 
  - Enhanced chunks with `pageNumber` fields for precise correlation
  - Improved `imageName` handling instead of full URLs
  - Text chunks with page-aware processing and cleaned content
- **Storage integration**: Configurable base paths for easy migration between storage providers

## New Parser Output Support

### Enhanced JSON Structure
The upload scripts now support the latest parser output format:

```json
{
    "book": {
        "title": "Book Title",
        "author": "Author Name",
        "totalChapters": 10,
        "totalWords": 45000,
        "coverImage": "page-001-image-1.jpg"
    },
    "chapters": [
        {
            "chapterNumber": 1,
            "title": "Chapter Title",
            "content": {
                "chunks": [
                    {
                        "index": 0,
                        "text": "Clean chapter content...",
                        "type": "text",
                        "wordCount": 150,
                        "pageNumber": 5
                    },
                    {
                        "index": 1,
                        "text": "",
                        "type": "image",
                        "wordCount": 0,
                        "pageNumber": 7,
                        "imageName": "page-007-image-1.jpg",
                        "imageAlt": "Figure 1 (Page 7)"
                    }
                ]
            },
            "wordCount": 3500,
            "startingPage": 5,
            "endingPage": 12
        }
    ],
    "metadata": {
        "parsedAt": "2024-01-01T00:00:00.000Z",
        "totalChapters": 10,
        "totalWords": 45000,
        "hasImages": true,
        "totalImages": 15,
        "imagesFolderPath": "./images/Book-Title"
    }
}
```

### Parser Summary Integration
Scripts now recognize and utilize the new `parser-summary.json` file for enhanced validation and reporting:

```json
{
    "bookInfo": {
        "title": "Book Title",
        "author": "Author Name",
        "parsedAt": "2024-01-01T00:00:00.000Z"
    },
    "overview": {
        "totalChapters": 10,
        "totalWords": 45000,
        "totalTextChunks": 2250,
        "totalImageChunks": 15,
        "totalChunks": 2265
    },
    "chapters": [
        {
            "chapterNumber": 1,
            "chapterName": "Chapter Title",
            "pageRanges": "From 5 to 12",
            "numberOfPages": 8,
            "textChunks": 225,
            "imageChunks": 2,
            "previewText": "Clean chapter preview..."
        }
    ]
}
```

## Error Handling

All scripts include comprehensive error handling:
- **Enhanced Validation**: Validates new chunk formats and page correlations
- **Storage Provider Support**: Handles different storage configurations
- **Page Correlation Verification**: Ensures image pageNumber fields are preserved
- **Clear Error Messages**: Improved error reporting with context
- **Rollback Support**: Safe operations with proper cleanup on failure

## Enhanced Text Processing Verification

The upload scripts now verify the latest text processing improvements:

### Text Quality Checks
- **Chapter Heading Removal**: Verifies clean chapter beginnings
- **Sentence Merging**: Validates proper sentence flow across pages  
- **Page Number Cleaning**: Ensures spurious page numbers are removed
- **Abbreviation Handling**: Confirms proper sentence splitting around abbreviations

### Image Correlation Verification
- **Page Number Validation**: Ensures all image chunks have correct pageNumber fields
- **Naming Convention**: Validates proper image file naming (`page-XXX-image-N.jpg`)
- **Chapter Association**: Confirms images are properly associated with chapters

## Storage Provider Configuration

### Vercel Blob Setup
```bash
# Set environment variable
export BLOB_READ_WRITE_TOKEN=your_vercel_token

# Images will be accessible at:
# https://xyz.public.blob.vercel-storage.com/books/Book-Title/images/
```

### AWS S3 Setup  
```bash
# Set environment variables
export AWS_ACCESS_KEY_ID=your_access_key
export AWS_SECRET_ACCESS_KEY=your_secret_key
export AWS_REGION=us-east-1

# Images will be accessible at:
# https://app-template-1252343.s3.amazonaws.com/Book_Reader_App/books/Book-Title/images/
```

The upload scripts automatically handle the different URL structures and storage configurations for optimal compatibility with the Book Reader App. 